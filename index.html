<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å€‹äººæ¯æ—¥æ‰“å¡</title>
<style>
body {
  font-family: system-ui;
  background: #0f172a;
  color: #e5e7eb;
  text-align: center;
  padding: 20px;
}
button {
  padding: 8px 14px;
  border-radius: 999px;
  border: none;
  margin: 6px;
  font-size: 1rem;
  background: #22c55e;
  color: #022c22;
  cursor: pointer;
}
.grid {
  display: grid;
  grid-template-columns: repeat(7, 14px);
  gap: 4px;
  justify-content: center;
  margin-top: 20px;
}
.day {
  width: 14px;
  height: 14px;
  border-radius: 3px;
  background: #1e293b;
  cursor: pointer;
}
.lvl1 { background: #86efac; }
.lvl2 { background: #4ade80; }
.lvl3 { background: #22c55e; }
.lvl4 { background: #16a34a; }
</style>
</head>
<body>

<h1>ğŸ“… å€‹äººæ¯æ—¥æ‰“å¡</h1>

<button id="checkinBtn">ä»Šå¤©æ‰“å¡</button>
<button id="exportBtn">åŒ¯å‡º CSV</button>

<p id="streak">ğŸ”¥ é€£çºŒæ‰“å¡ 0 å¤©</p>

<div class="grid" id="grid"></div>

<script>
const KEY = "checkin_history";
const DAYS = 112;
const FIXED_NAME = "è”¡æ˜å‹³";

const grid = document.getElementById("grid");
const streakEl = document.getElementById("streak");

// è®€è³‡æ–™
function load() {
  return JSON.parse(localStorage.getItem(KEY)) || [];
}
function save(data) {
  localStorage.setItem(KEY, JSON.stringify(data));
}
function today() {
  return new Date().toISOString().split("T")[0];
}
function currentTime() {
  return new Date().toLocaleTimeString();
}

// æ‰“å¡
document.getElementById("checkinBtn").onclick = () => {
  const data = load();
  const t = today();
  if (data.find(e => e.date === t)) { alert("ä»Šå¤©å·²æ‰“éå¡"); return; }

  data.push({ date: t, time: currentTime() });
  save(data);
  render();
};

// è¨ˆç®—é€£çºŒå¤©æ•¸
function calcStreak(data) {
  let streak = 0;
  let d = new Date();
  while (data.find(e => e.date === d.toISOString().split("T")[0])) {
    streak++;
    d.setDate(d.getDate() - 1);
  }
  return streak;
}

// æ ¼å­é¡è‰²
function getLevel(dateStr, data) {
  let count = 0;
  const d = new Date(dateStr);
  for (let i = 0; i < 4; i++) {
    const key = new Date(d);
    key.setDate(d.getDate() - i);
    const keyStr = key.toISOString().split("T")[0];
    if (data.find(e => e.date === keyStr)) count++;
  }
  return Math.min(count, 4);
}

// ç•«æ ¼å­
function render() {
  const data = load();
  grid.innerHTML = "";

  for (let i = DAYS - 1; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split("T")[0];
    const div = document.createElement("div");
    div.className = `day lvl${getLevel(dateStr, data)}`;

    // hover é¡¯ç¤ºæ‰“å¡æ™‚é–“
    const entry = data.find(e => e.date === dateStr);
    if (entry) div.title = `${dateStr} ${entry.time}`;
    else div.title = `${dateStr}ï¼ˆæœªæ‰“å¡ï¼‰`;

    // é»æ ¼å­è£œæ‰“å¡
    div.onclick = () => {
      const existing = data.find(e => e.date === dateStr);
      if (!existing) {
        data.push({ date: dateStr, time: currentTime() });
        save(data);
        render();
      } else {
        alert(`${dateStr} å·²æ‰“éå¡ï¼ˆ${existing.time}ï¼‰`);
      }
    };

    grid.appendChild(div);
  }

  streakEl.textContent = `ğŸ”¥ é€£çºŒæ‰“å¡ ${calcStreak(data)} å¤©`;
}

render();

// åŒ¯å‡º CSV
document.getElementById("exportBtn").onclick = () => {
  const data = load();
  if (data.length === 0) { alert("æ²’æœ‰æ‰“å¡è³‡æ–™å¯ä»¥åŒ¯å‡º"); return; }

  let csv = "å§“å,æ—¥æœŸ,æ™‚é–“,æ˜¯å¦æ‰“å¡\n";
  data.forEach(e => {
    csv += `${FIXED_NAME},${e.date},${e.time},æ˜¯\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${FIXED_NAME}_æ‰“å¡ç´€éŒ„.csv`;
  link.click();
};
</script>

</body>
</html>
